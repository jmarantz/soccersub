
# Tools needed:
#   closure compiler: https://dl.google.com/closure-compiler/compiler-latest.zip
#   java runtime: sudo apt-get install jvm-7-avian-jre
#   node.js
#   npm
#   firebase

export PATH := /usr/local/bin:$(PATH)

#CLOSURE_VERSION = v20161024
CLOSURE_VERSION = v20171112
COMPILER_JAR = $(HOME)/bin/closure-compiler-$(CLOSURE_VERSION).jar
CLOSURE_LIB = $(HOME)/dev/closure-library
BUILD = $(CLOSURE_LIB)/closure/bin/build/closurebuilder.py \
	  --root=$(CLOSURE_LIB)/ \
	  --root=public/js

deploy : public/deploy_timestamp.js
xcompile : public/soccersub.min.js

.PHONY: deploy compile jsopts

include Makefile.deps
include Makefile.testdeps

jsopts : $(JSFILES) Makefile
	java -jar $(HOME)/bin/closure-compiler-v20161024.jar --help


# Describes where the public files are located relative to the closure
# library.
export PREFIX = ../../..

TEST_SOURCES = $(filter-out public/js/test.js,$(TEST_JSFILES))
public/js/test.js : Makefile $(TEST_SOURCES)
	./gentest.sh $(filter-out public/js/test.js,$(TEST_SOURCES)) >$@

deps :
	./gendeps.sh soccersubMain public/deps.js Makefile.deps JSFILES
	./gendeps.sh soccersubTest public/testdeps.js Makefile.testdeps TEST_JSFILES

compile : public/soccersub.min.js public/soccersub.testmin.js public/opt.html public/test.html public/test_opt.html
.PHONY : deps compile

public/opt.html : public/soccersub.html Makefile
	sed -e 's@<script src="closure-library/closure/goog/base.js"></script>@@' \
	    -e 's@deps.js@soccersub.min.js@' \
	    -e 's@<!--MasterCopy-->@<!-- Generated by Makefile from soccersub.html -- do not edit -->@' \
		< $< > $@

public/test.html : public/soccersub.html Makefile
	sed -e 's@deps.js@testdeps.js@' \
	    -e 's@soccersubMain@soccersubTest@' \
	    -e 's@<!--MasterCopy-->@<!-- Generated by Makefile from soccersub.html -- do not edit -->@' \
	        < $< > $@

public/test_opt.html : public/opt.html Makefile
	sed -e 's@soccersub.min.js@soccersub.testmin.js@' \
	    -e 's@soccersubMain@soccersubTest@' \
	        < $< > $@

COMPILE = $(BUILD) \
	  --compiler_jar=$(COMPILER_JAR) \
	  --compiler_flags="--compilation_level=ADVANCED_OPTIMIZATIONS" \
	  --output_mode=compiled \
	  --compiler_flags="--warning_level=VERBOSE" \
	  --output_file=$@ 

public/soccersub.min.js : $(JSFILES) Makefile
	$(COMPILE) --namespace="soccersubMain" 2>&1 | grep -v ButtonSet

public/soccersub.testmin.js : $(TEST_JSFILES) Makefile
	$(COMPILE) --namespace="soccersubTest" 2>&1 | \
	    egrep -v '(ButtonSet|goog.structs.Map)'

public/xxsoccersub.min.js : $(JSFILES) Makefile
	java -jar $(HOME)/bin/closure-compiler-$(CLOSURE_VERSION).jar \
		--process_closure_primitives \
		--dependency_mode=LOOSE \
		--output_manifest=outfiles.list \
		--compilation_level=ADVANCED_OPTIMIZATIONS \
		--warning_level=VERBOSE \
		--js_output_file $@ \
		--js $(JSFILES)
	sed -e s@public/@@g <outfiles.list | \
		awk '{print "<script src=\"" $$1 "\"></script>"}'

SRCS = public/soccersub.min.js public/soccersub.css public/soccersub.html \
	public/DownLeft32.png

public/deploy_timestamp.js : compile firebase.json $(SRCS) $(JSFILES) Makefile 
	./write_deploy_timestamp.sh >$@
	/usr/local/bin/firebase deploy --only hosting

git_setup :
	git remote set-url origin git@github.com:jmarantz/quickstart-js.git
