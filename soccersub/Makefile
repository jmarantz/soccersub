
# Tools needed:
#   closure compiler: https://dl.google.com/closure-compiler/compiler-latest.zip
#   java runtime: sudo apt-get install jvm-7-avian-jre
#   node.js
#   npm
#   firebase

export PATH := /usr/local/bin:$(PATH)

#CLOSURE_VERSION = v20161024
CLOSURE_VERSION = v20171112
COMPILER_JAR = $(HOME)/bin/closure-compiler-$(CLOSURE_VERSION).jar
CLOSURE_LIB = $(HOME)/dev/closure-library
BUILD = $(CLOSURE_LIB)/closure/bin/build/closurebuilder.py \
	  --root=$(CLOSURE_LIB)/ \
	  --root=public/js

deploy : public/deploy_timestamp.js
xcompile : public/soccersub.min.js

.PHONY: deploy compile jsopts

JSFILES = public/js/soccersub.js public/js/game.js public/js/position.js \
	public/js/player.js public/js/main.js public/js/lineup.js \
	public/js/util.js public/js/storage.js public/js/array_section.js \
	public/js/map_section.js public/js/plan.js public/js/drag.js \
	public/js/plan_calculator.js public/js/assignment.js \
	public/js/assignment2.js

TEST_JSFILES = public/js/lineup_test.js public/js/plan_calculator_test.js 

jsopts : $(JSFILES) Makefile
	java -jar $(HOME)/bin/closure-compiler-v20161024.jar --help


# Describes where the public files are located relative to the closure
# library.
export PREFIX = ../../..

public/deps.js : Makefile ./gendeps.sh $(JSFILES)
	$(BUILD) --namespace="soccersubMain" | ./gendeps.sh >$@

public/testdeps.js : Makefile ./gendeps.sh $(JSFILES) $(TEST_JSFILES) public/js/test.js
	$(BUILD) --namespace="soccersubTest" | ./gendeps.sh >$@

public/js/test.js : Makefile $(TEST_JSFILES)
	./gentest.sh $(TEST_JSFILES) >$@

deps : public/deps.js public/testdeps.js
compile : public/soccersub.min.js public/opt.html public/test.html
.PHONY : deps compile

public/opt.html : public/soccersub.html Makefile
	sed -e 's@<script src="closure-library/closure/goog/base.js"></script>@@' \
	    -e 's@deps.js@soccersub.min.js@' \
	    -e 's@<!--MasterCopy-->@<!-- Generated by Makefile from soccersub.html -- do not edit -->@' \
		< $< > $@

public/test.html : public/soccersub.html Makefile
	sed -e 's@deps.js@testdeps.js@' \
	    -e 's@soccersubMain@soccersubTest@' \
	    -e 's@<!--MasterCopy-->@<!-- Generated by Makefile from soccersub.html -- do not edit -->@' \
	        < $< > $@

public/soccersub.min.js : $(JSFILES) Makefile
	$(BUILD) --namespace="soccersubMain" \
	  --compiler_jar=$(COMPILER_JAR) \
	  --compiler_flags="--compilation_level=ADVANCED_OPTIMIZATIONS" \
	  --output_mode=compiled \
	  --compiler_flags="--warning_level=VERBOSE" \
	  --output_file=$@ 2>&1 | grep -v ButtonSet

public/xxsoccersub.min.js : $(JSFILES) Makefile
	java -jar $(HOME)/bin/closure-compiler-$(CLOSURE_VERSION).jar \
		--process_closure_primitives \
		--dependency_mode=LOOSE \
		--output_manifest=outfiles.list \
		--compilation_level=ADVANCED_OPTIMIZATIONS \
		--warning_level=VERBOSE \
		--js_output_file $@ \
		--js $(JSFILES)
	sed -e s@public/@@g <outfiles.list | \
		awk '{print "<script src=\"" $$1 "\"></script>"}'

SRCS = public/soccersub.min.js public/soccersub.css public/soccersub.html \
	public/DownLeft32.png

public/deploy_timestamp.js : compile firebase.json $(SRCS) $(JSFILES) Makefile 
	./write_deploy_timestamp.sh >$@
	/usr/local/bin/firebase deploy --only hosting

git_setup :
	git remote set-url origin git@github.com:jmarantz/quickstart-js.git
